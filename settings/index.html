<!doctype html>
<html>
<head>
	<script type="text/javascript" src="/manager/webserver/assets/js/jquery.js"></script>
	<script type="text/javascript" src="/homey.js" data-origin="settings"></script>
</head>
<body>

<h1 data-i18n="settings.title"></h1>

<div id="unregistered">
	<p data-i18n="settings.info"></p>

	<input class="device_id" type="text" value="/register 12345">
</div>

<div id="registered" style="display: none">

	<p id="already_bot" data-i18n="settings.already_registered"></p>
	
	<p id="already_own_bot" data-i18n="settings.already_registered_own_bot"></p>

</div>

<hr>

<div id="delete_bot">
	<button id="deletebot" data-i18n="settings.delete_bot"></button>
</div>

<div id="own_bot">
	<h2 data-i18n="settings.own_bot"></h2>
	<p data-i18n="settings.own_bot_description"></p>
	<ul>
		<li class='own_bot_1' data-i18n="settings.step1"></li>
		<li class='own_bot_1' data-i18n="settings.step2"></li>
		<li class='own_bot_1' data-i18n="settings.step3"></li>
		<li class='own_bot_1' data-i18n="settings.step4"></li>
		<li class='own_bot_1' data-i18n="settings.step5"></li>
		<div  class='own_bot_1'><span data-i18n="settings.token"></span>: <input type="text" name="token" id="token" value=""><button type="submit" id="submit" data-i18n="settings.save"></button></div>
		<li data-i18n="settings.step6"></li>
		<li data-i18n="settings.step7"></li>
		<li data-i18n="settings.step8"></li>
		
	</ul>
	
	

</div>

<hr>

<div id="connected_users">
	
	<h2 data-i18n="settings.connected_users"></h2>
	
	<div id="connected_users_list"></div>
	
</div>

<script type="text/javascript">

    // Initialize Homey
    function onHomeyReady(Homey) {
        Homey.ready();

        // Fill input with already stored settings
        Homey.get("device_id", function (err, value) {
            if (value) {
                $('.device_id').val('/register ' + value);
                $('#device_id_unregister').val('/unregister ' + value);
            }
        });
        
        Homey.get("chat_id", function (err, value) {
	        
	        if (value) {
		        $('#unregistered').css('display', 'none');
				$('#registered').css('display', 'block');
	        }
	        
	    });
	    
	    Homey.get("bot_token", function (err, value) {
	        
	        if (value && value != '') {
		        
		        $('#already_bot').css('display', 'none');
				$('#own_bot').css('display', 'none');
				$('#token').val(value);
				
				$('#deletebot').css('display', 'block');
				
	        } else {
		        
		        $('#already_own_bot').css('display', 'none');
		        $('#deletebot').css('display', 'none');
		        
	        }
	    });
	    
	    Homey.get("chat_ids", function (err, chat_ids) {
		    
		    for (var key in chat_ids) {
			    
			    var html = '<div class="span_' + key + '"> ' + chat_ids[key].name + ' ';
			    if (typeof chat_ids[key].description !== 'undefined') {
				    
				    html += ' (Group) ';
				    
			    }
			    html += '<a href="#" class="delete" data-id="' + key + '">' + __('settings.delete') + '</a>';
				html += '</div>';
				
				$('#connected_users_list').append (html);
				
			}
		    
		});
		
		$('body').on('click', '.delete', function () {
			
			var remove_key = $(this).data('id');
			
			Homey.confirm (__("settings.are_you_sure"), "warning", function(err, result) {
				
				if (result) {
					
					$('.span_' + remove_key).remove();
					
					Homey.get("chat_ids", function (err, chat_ids) {
						
						console.log ('chat_ids = ' + JSON.stringify(chat_ids));

						//var new_chat_ids = Object.assign ({}, chat_ids);
						
						//console.log ('new_chat_ids BEFORE = ' + JSON.stringify(new_chat_ids));
					
						//delete chat_ids[remove_key];
						chat_ids.splice(remove_key, 1);
						
						console.log ('chat_ids AFTER = ' + JSON.stringify(chat_ids));
						
						Homey.set("chat_ids", chat_ids, function() {
							
							//Homey.alert("saved");
							
						});
					
					});
				
				}
				
			});
			
		});
	    
	    $('#submit').on('click', function() {
		
			 Homey.api( 'PUT', '/addbot/', {
				 
				"bot_token": $('#token').val()
				 
			}, function( msg, result ){
				
				if (msg == 'Finished!') {
					Homey.set('bot_token', $('#token').val());
					
					$('.own_bot_1').css('display', 'none');
					
					Homey.alert (__("settings.success"));
					
				} else {
					Homey.alert(msg);
				}
				
			});
			
	    });
	    
	    $('#deletebot').on('click', function() {

			Homey.api( 'PUT', '/deletebot/', {}, function( msg, result ){
				
				if (msg == 'Finished!') {
					
					$('#own_bot').css('display', 'true');
					$('#delete_bot').css('display', 'none');
					$('#token').val('');
					
				}
				
			});
			
	    });
	    
    }
</script>

</body>
</html>